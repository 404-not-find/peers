<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

  <title>Peers javascript demo page</title>

  <style type="text/css">

  #logger, #networkLogger {
    border: 1px solid black;
    width: 45%;
    height: 300px;
    float: left;
    margin: 10px;
    overflow: auto;
    white-space: pre-line;
  }

  #account {
    border: none;
  }

  #incomingCall {
    display: none;
  }

  </style>

  <script type="text/javascript">

  var inviteSipRequest;

  function localLog(prefix, message, divId) {
    var logger = document.getElementById(divId);
    var line = "";
    if (prefix) {
      line = prefix + " ";
    }
    line += message;
    var node = document.createTextNode(line);
    logger.appendChild(node);
    node = document.createElement("br");
    logger.appendChild(node);
  }

  function javaLog(message) {
    localLog("java", message, "logger");
  }

  function javaNetworkLog(message) {
    var htmlMessage
    localLog(null, message, "networkLogger");
  }

  function log(message) {
    var date = new Date();
    var line = date.getFullYear() + "-" + (date.getMonth() + 1) + "-";
    line += date.getDate() + " " + date.getHours() + ":" + date.getMinutes();
    line += ":" + date.getSeconds() + "," + date.getMilliseconds();
    line += " " + message;
    localLog("js", line, "logger");
  }

  // server functions

  function registering(sipRequest) {
    log("registering");
  }

  function registerSuccessful(sipResponse) {
    log("registerSuccessful " + sipResponse.getStatusCode());
  }

  function registerFailed(sipResponse) {
    log("registerFailed " + sipResponse);
  }

  function incomingCall(sipRequest, provResponse) {
    log("incomingCall");
    inviteSipRequest = sipRequest;
    var incomingCall = document.getElementById("incomingCall");
    var caller = document.getElementById("caller");
    var fromStr = peers.getFrom(sipRequest);
    var from = document.createTextNode(fromStr);
    caller.appendChild(from);
    incomingCall.style = "display: block";
  }

  function remoteHangup(sipRequest) {
    log("remoteHangup");
    var callAction = document.getElementById("callAction");
    callAction.value = "call";
    // cleanup for incoming calls cancelled
    var incomingCall = document.getElementById("incomingCall");
    incomingCall.style = "display: none";
    var caller = document.getElementById("caller");
    caller.innerHTML = "";
  }

  function ringing(sipResponse) {
    log("ringing");
  }

  function calleePickup(sipResponse) {
    log("calleePickup");
  }

  function error(sipResponse) {
    log("error " + sipResponse);
    var callAction = document.getElementById("callAction");
    callAction.value = "call";
  }

  function setInviteSipRequest(sipRequest) {
    log("setInviteSipRequest " + sipRequest);
    inviteSipRequest = sipRequest;
  }

  // client functions

  function registerAction() {
    log("registerAction");
    var peers = document.getElementById("peers");
    var registerAction = document.getElementById("registerAction");
    if (registerAction.value == "register") {
      var userPart = document.getElementById("userPart");
      var domain = document.getElementById("domain");
      var password = document.getElementById("password");
      var outboundProxy = document.getElementById("outboundProxy");
      registerAction.value = "unregister";
      peers.register(userPart.value, password.value, domain.value,
          outboundProxy.value);
    } else {
      registerAction.value = "register";
      peers.unregister();
    }

  }

  function callAction() {
    log("callAction");
    var peers = document.getElementById("peers");
    var callAction = document.getElementById("callAction");
    if (callAction.value == "call") {
      var callee = document.getElementById("callee");
      callAction.value = "hangup";
      peers.invite(callee.value);
    } else {
      callAction.value = "call";
      peers.terminate(inviteSipRequest);
    }
  }

  function reject() {
    log("reject");
    var peers = document.getElementById("peers");
    peers.busyHereClicked(inviteSipRequest);
    var incomingCall = document.getElementById("incomingCall");
    incomingCall.style = "display: none";
    var caller = document.getElementById("caller");
    caller.innerHTML = "";
  }

  function pickup() {
    log("pickup");
    var peers = document.getElementById("peers");
    peers.pickupClicked(inviteSipRequest);
    var incomingCall = document.getElementById("incomingCall");
    incomingCall.style = "display: none";
    var caller = document.getElementById("caller");
    caller.innerHTML = "";
    var callAction = document.getElementById("callAction");
    callAction.value = "hangup";
  }
  </script>

</head>

<body>
    <script src="deployJava.js"></script>
    <script type="text/javascript">
        var attributes = { id:'peers', code:'net.sourceforge.peers.javascript.JsUserAgent',  width:1, height:1} ;
        var parameters = {jnlp_href: 'applet-tests.jnlp'} ;
        deployJava.runApplet(attributes, parameters, '1.6');
    </script>
    <table id="account">
      <tbody>
        <tr>
          <td>user part:</td>
          <td><input id="userPart" type="text" value="demo-alice"/></td>
          <td></td>
        </tr>
        <tr>
          <td>domain:</td>
          <td><input id="domain" type="text" value="pc-yohann"/></td>
          <td></td>
        </tr>
        <tr>
          <td>password:</td>
          <td><input id="password" type="password" value="5!mJ0z3j"/></td>
          <td></td>
        </tr>
        <tr>
          <td>outbound proxy:</td>
          <td><input id="outboundProxy" type="text"/></td>
          <td>(example: sip:192.168.1.20;lr)</td>
        </tr>
      </tbody>
    </table>
    <div>
      <input id="registerAction" type="button" value="register" onclick="registerAction()"/>
    </div>
    <div>
      callee: <input id="callee" type="text"/> (example: sip:6002@asterisk-ip)
    </div>
    <div>
      <input id="callAction" type="button" value="call" onclick="callAction()"/>
    </div>
    <div id="incomingCall">
      incoming call from <div id="caller"></div>
      <input id="reject" type="button" value="reject" onclick="reject()"/>
      <input id="pickup" type="button" value="pickup" onclick="pickup()"/>
    </div>
    <div id="logger"></div>
    <div id="networkLogger"></div>
</body>

</html>

